SELECT *
FROM (
    SELECT *
    FROM RTSP.TOKEN_TRANLOG
    WHERE TRUNC(TDATE) = TRUNC(SYSDATE) - 1
      AND TXN_ID IN (
          SELECT TXN_ID
          FROM RTSP.TOKEN_TRANLOG
          WHERE TRUNC(TDATE) = TRUNC(SYSDATE) - 1
          GROUP BY TXN_ID
          HAVING MAX(CASE WHEN STATUS != 'C' THEN 1 ELSE 0 END) = 1
      )
    ORDER BY TXN_ID, TDATE
) t
WHERE t.TXN_ID IN (
    SELECT TXN_ID
    FROM (
        SELECT TXN_ID,
               ROW_NUMBER() OVER (PARTITION BY TXN_ID ORDER BY TDATE) AS rn,
               STATUS
        FROM RTSP.TOKEN_TRANLOG
        WHERE TRUNC(TDATE) = TRUNC(SYSDATE) - 1
    )
    WHERE rn = 1 AND STATUS != 'C'
);

----q2
SELECT *, ROW_NUMBER() OVER (PARTITION BY TXN_ID ORDER BY TDATE) AS rn 
FROM RTSP.TOKEN_TRANLOG 
WHERE TRUNC(TDATE) >= TRUNC(SYSDATE) - 1 
    AND TRUNC(TDATE) <TRUNC(SYADATE)
    AND STATUS !='C';
