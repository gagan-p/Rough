SELECT *
FROM (
    SELECT *
    FROM RTSP.TOKEN_TRANLOG
    WHERE TRUNC(TDATE) = TRUNC(SYSDATE) - 1
      AND TXN_ID IN (
          SELECT TXN_ID
          FROM RTSP.TOKEN_TRANLOG
          WHERE TRUNC(TDATE) = TRUNC(SYSDATE) - 1
          GROUP BY TXN_ID
          HAVING MAX(CASE WHEN STATUS != 'C' THEN 1 ELSE 0 END) = 1
      )
    ORDER BY TXN_ID, TDATE
) t
WHERE t.TXN_ID IN (
    SELECT TXN_ID
    FROM (
        SELECT TXN_ID,
               ROW_NUMBER() OVER (PARTITION BY TXN_ID ORDER BY TDATE) AS rn,
               STATUS
        FROM RTSP.TOKEN_TRANLOG
        WHERE TRUNC(TDATE) = TRUNC(SYSDATE) - 1
    )
    WHERE rn = 1 AND STATUS != 'C'
);

----q2
SELECT
    ROW_NUMBER()
    OVER(PARTITION BY t.txn_id
         ORDER BY
             t.tdate
    ) AS rn,
    t.id,
    t.req_ts,
    t.duration,
    t.itc,
    t.display_message,
    t.txn_id,
    t.irc,
    t.pso_rc,
    t.cbs_rc,
    t.tomas_rc,
    t.tomas_confirm_rc,
    t.ext_rc,
    t.cbs_reversal_rc,
    t.cbs_irc,
    t.cbs_irc_details,
    t.amount,
    t.tdate,
    t.capture_date,
    t.status,
    t.type,
    t.rc,
    t.init_vector
FROM
    rtsp.token_tranlog t
WHERE
        trunc(t.tdate) >= trunc(sysdate) - 1
    AND trunc(t.tdate) < trunc(sysdate)
    AND t.status != 'C'
